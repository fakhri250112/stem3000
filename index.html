<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunnah Lifestyle â€” Final (PWA, External Quran JSON)</title>

  <!-- PWA manifest & icon -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#16a34a">
  <link rel="icon" href="icons/icon-192.png" type="image/png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-1: #02131a;
      --accent: #06b6d4;
      --card: rgba(255,255,255,0.04);
      --muted: rgba(230,238,240,0.78);
    }
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height:100vh; color:#e6eef0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(14,165,162,0.06), transparent 10%), linear-gradient(135deg,#02131a 0%, #04323a 45%, #0ea5a2 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding:18px;
    }
    .container{ max-width:1100px; margin:0 auto; }
    .glass{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.6); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.03); }
    .mini{ background: rgba(255,255,255,0.03); padding:10px; border-radius:10px; }
    .small-muted{ color:var(--muted); font-size:0.92rem; }
    #map{ height:360px; border-radius:10px; }
    .pill{ background: rgba(255,255,255,0.06); padding:4px 10px; border-radius:999px; font-weight:700; color:#02131a; }
    .btn{ padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn-emerald{ background:linear-gradient(90deg,#34d399,#10b981); color:#02131a; }
    .btn-yellow{ background:linear-gradient(90deg,#facc15,#f59e0b); color:#02131a; }
    .btn-soft{ background:rgba(255,255,255,0.05); color:inherit; border:1px solid rgba(255,255,255,0.03); }
    .scroll-y{ max-height:260px; overflow:auto; padding-right:6px; }
    .locked{ opacity:0.45; }
    .streak-badge{ padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#f97316,#f59e0b); color:#02131a; font-weight:800; }
    .quote{ font-style:italic; font-weight:600; color:#e6eef0; }
    .surah-box{ border-left:3px solid var(--accent); padding-left:10px; margin-bottom:8px; }
    .hidden{ display:none !important; }
    footer{ margin-top:20px; text-align:center; color:var(--muted); font-size:0.9rem; }
    @media (max-width:1024px){ #map{ height:260px; } }
  </style>
</head>

<body>
  <div class="container">
    <header class="text-center mb-6">
      <div class="glass inline-block p-5" style="width:100%;">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <img id="appIcon" src="https://cdn.pixabay.com/photo/2023/11/30/10/45/allah-8421334_1280.png" alt="icon" class="w-20 h-20 rounded-full bg-white p-2" />
            <div>
              <h1 class="text-2xl font-extrabold">Sunnah Lifestyle</h1>
              <div class="small-muted">Healthy habits â€¢ Prayer reminders â€¢ Sustainable living</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right small-muted">
              <div id="currentTime" class="text-lg font-semibold">--:--:--</div>
              <div id="locationDisplay" class="small-muted">Detecting location...</div>
            </div>
            <div class="streak-badge" id="streakBadge">0</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Dashboard -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- Left column: time, prayer, meals -->
      <section class="lg:col-span-1 space-y-4">
        <div class="glass p-5">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-lg font-bold">Current Time</h2>
              <div id="currentTimeAlt" class="text-2xl mt-1 font-semibold">--:--:--</div>
              <div id="locationDisplayAlt" class="small-muted mt-1">Detecting...</div>
            </div>
            <div class="text-right">
              <button id="enableNotifBtn" class="mt-2 px-3 py-2 btn btn-emerald">Enable Notifications</button>
              <div id="ttsToggleWrap" class="mt-2 small-muted cursor-pointer">TTS: <span id="ttsStatus">on</span></div>
            </div>
          </div>
          <hr class="my-3 border-white/10" />
          <h3 class="font-semibold">Next Prayer</h3>
          <div id="nextPrayer" class="mt-2 text-lg">Loading...</div>
          <div id="prayerCountdown" class="small-muted mt-1">â€”</div>
          <ul id="prayerList" class="mt-3 space-y-1 small-muted"></ul>
        </div>

        <div class="glass p-5">
          <h3 class="text-lg font-bold">Murajaah (Juz 30)</h3>
          <div class="small-muted">3 surat / hari â€” teks diambil dari <code>data/quran.json</code></div>
          <div id="murajaahBox" class="mt-3 scroll-y"></div>
          <div class="mt-3 flex gap-2">
            <button id="markMurajaahAll" class="btn btn-emerald">Mark All Read</button>
            <button id="resetMurajaah" class="btn btn-soft">Reset Murajaah Today</button>
          </div>
        </div>

        <div class="glass p-5">
          <h3 class="text-lg font-bold">Meals (fixed)</h3>
          <p class="small-muted">Checklist aktif pada window jam makan</p>
          <div class="mt-3 space-y-2">
            <div class="mini flex justify-between items-center">
              <div><b>Breakfast</b><div class="small-muted">07:00 â€” 09:00</div></div>
              <div><input type="checkbox" id="chkBreakfast" /> <span id="breakfastMenu" class="small-muted ml-2">â€”</span></div>
            </div>
            <div class="mini flex justify-between items-center">
              <div><b>Lunch</b><div class="small-muted">12:30 â€” 14:00</div></div>
              <div><input type="checkbox" id="chkLunch" /> <span id="lunchMenu" class="small-muted ml-2">â€”</span></div>
            </div>
            <div class="mini flex justify-between items-center">
              <div><b>Dinner</b><div class="small-muted">18:30 â€” 20:00</div></div>
              <div><input type="checkbox" id="chkDinner" /> <span id="dinnerMenu" class="small-muted ml-2">â€”</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Middle column: tracker + exercise -->
      <section class="lg:col-span-1 space-y-4">
        <div class="glass p-5">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold">Activity Tracker (GPS)</h3>
            <div class="small-muted">Record runs/walks, pace</div>
          </div>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div id="map" class="md:col-span-2"></div>
            <div class="space-y-2">
              <div class="mini"><div class="small-muted">Status</div><div id="trackStatus">Idle</div></div>
              <div class="mini"><div class="small-muted">Distance</div><div id="trackDistance">0.00 km</div></div>
              <div class="mini"><div class="small-muted">Elapsed</div><div id="trackElapsed">00:00:00</div></div>
              <div class="mini"><div class="small-muted">Pace</div><div id="trackPace">â€”</div></div>

              <div class="mt-2 space-y-2">
                <button id="startTrack" class="btn btn-emerald w-full">Start</button>
                <button id="pauseTrack" class="btn btn-yellow w-full">Pause</button>
                <button id="stopTrack" class="btn btn-soft w-full">Stop & Save</button>
              </div>
            </div>
          </div>

          <hr class="my-3 border-white/6" />
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold">Saved Runs</h4>
              <div class="flex gap-2">
                <button id="exportAllRunsBtn" class="btn btn-soft">Export</button>
                <button id="clearRunsBtn" class="btn btn-soft">Clear</button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="mini scroll-y" id="runsListWrap"></div>
              <div class="mini">
                <div class="small-muted">Selected Run</div>
                <div id="runDetail" class="mt-2 small-muted">No run selected</div>
                <div class="mt-3 flex gap-2">
                  <button id="viewRunOnMapBtn" class="btn btn-emerald">View on Map</button>
                  <button id="deleteRunBtn" class="btn btn-soft">Delete</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass p-5">
          <h3 class="text-lg font-bold">Exercise Schedule</h3>
          <div class="small-muted">Daily routine â€” can only check today's items</div>
          <div id="exerciseSchedule" class="mt-3 space-y-2 scroll-y"></div>
        </div>
      </section>

      <!-- Right column: trash, eco, daily checklist -->
      <section class="lg:col-span-1 space-y-4">
        <div class="glass p-5">
          <h3 class="text-lg font-bold">â™» Trash Taked</h3>
          <div class="small-muted">Log daily trash (grams)</div>
          <div class="mt-3 space-y-2">
            <input id="trashType" placeholder="Type (Plastic / Organic)" class="w-full p-2 rounded bg-white/5" />
            <input id="trashWeight" placeholder="Weight (grams)" type="number" class="w-full p-2 rounded bg-white/5" />
            <div class="flex gap-2">
              <button id="addTrashBtn" class="flex-1 btn btn-emerald">Add</button>
              <button id="clearTrashBtn" class="btn btn-soft">Clear Today</button>
            </div>
            <div class="mt-3 small-muted">Today log</div>
            <ul id="trashList" class="mt-2 small-muted space-y-1 max-h-40 overflow-auto"></ul>
            <div class="mt-2 font-semibold" id="trashTotal">Total: 0 g</div>
          </div>
        </div>

        <div class="glass p-5">
          <h3 class="text-lg font-bold">ðŸŒ± Eco-Challenges</h3>
          <div class="small-muted">Complete tasks to earn eco points</div>
          <ul id="challengeList" class="mt-3 space-y-2"></ul>
          <div class="mt-3 small-muted">Points: <span id="ecoPoints">0</span></div>
        </div>

        <div class="glass p-5">
          <h3 class="text-lg font-bold">Daily Checklist & Streak</h3>
          <div class="small-muted">Centang tiap item yang kamu lakukan hari ini</div>
          <div class="mt-3">
            <label class="mini flex items-center gap-2"><input type="checkbox" id="chkAllExercise" /> <div><b>Olahraga (sesi hari ini)</b></div></label>
            <label class="mini flex items-center gap-2"><input type="checkbox" id="chkAllEco" /> <div><b>Eco Done</b></div></label>
            <div class="mt-3 flex gap-2">
              <button id="saveChecklistBtn" class="btn btn-emerald">Submit</button>
              <button id="clearChecklistBtn" class="btn btn-soft">Clear</button>
            </div>
            <div class="mt-2 small-muted">Last submit: <span id="lastChecklist">â€”</span></div>
            <div class="mt-2 small-muted">Restores left this month: <span id="restoresLeft">3</span></div>
          </div>
        </div>
      </section>

    </main>

    <!-- History button & section -->
    <div class="text-center mt-6">
      <button id="toggleHistoryBtn" class="btn btn-yellow">ðŸ“œ History (Previous Days)</button>
    </div>

    <section id="historySection" class="glass mt-4 hidden" style="display:none;">
      <h3 class="text-lg font-bold">ðŸ“œ History</h3>
      <div id="historyList" class="mt-3 small-muted"></div>
    </section>

    <footer>App Developed by Fakhri - Group 3 â€¢ PWA</footer>
  </div>

  <!-- =========================
       SCRIPT: Main logic
       ========================= -->
  <script>
  /* =========================
     Globals & UI refs
     ========================= */
  const nowEl = document.getElementById('currentTime');
  const nowElAlt = document.getElementById('currentTimeAlt');
  const locationDisplay = document.getElementById('locationDisplay');
  const locationDisplayAlt = document.getElementById('locationDisplayAlt');
  const enableNotifBtn = document.getElementById('enableNotifBtn');
  const ttsToggleWrap = document.getElementById('ttsToggleWrap');
  const ttsStatusEl = document.getElementById('ttsStatus');
  const prayerListEl = document.getElementById('prayerList');
  const nextPrayerEl = document.getElementById('nextPrayer');
  const prayerCountdownEl = document.getElementById('prayerCountdown');
  const prayerChecklistEl = document.getElementById('prayerChecklist') || (function(){ const el = document.createElement('div'); el.id='prayerChecklist'; document.getElementById('prayerList').parentNode.appendChild(el); return el; })();

  const murajaahBox = document.getElementById('murajaahBox');
  const exerciseScheduleEl = document.getElementById('exerciseSchedule');

  let userCoords = null;
  let ttsEnabled = (localStorage.getItem('ttsEnabled') !== 'false');
  let notifEnabled = (localStorage.getItem('notifEnabled') === 'true');
  let quranData = null; // loaded from data/quran.json

  function pad(n){ return String(n).padStart(2,'0'); }
  function updateClock(){ const d=new Date(); nowEl.textContent = d.toLocaleTimeString(); nowElAlt.textContent = d.toLocaleTimeString(); }
  setInterval(updateClock, 1000); updateClock();

  /* storage helpers */
  function loadJSON(k, fallback){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
  function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

  /* TTS helper */
  function selectVoicePref(langPref){
    const vs = speechSynthesis.getVoices();
    if(!vs || vs.length===0) return null;
    let v = vs.find(x => x.lang && x.lang.startsWith(langPref));
    if(v) return v;
    v = vs.find(x => /Google|Microsoft|Samantha|Alex|en-US|en-GB|id-ID/i.test(x.name));
    return v || vs[0];
  }
  function speak(text, lang='id-ID'){
    if(!ttsEnabled) return;
    try{
      const u = new SpeechSynthesisUtterance(String(text));
      u.lang = lang || 'id-ID';
      const v = selectVoicePref((lang||'id').split('-')[0]);
      if(v) u.voice = v;
      u.rate = 1;
      u.pitch = 1;
      // cancel existing to avoid overlap
      speechSynthesis.cancel();
      setTimeout(()=> speechSynthesis.speak(u), 50);
    }catch(e){ console.warn('TTS err', e); }
  }

  ttsToggleWrap.addEventListener('click', ()=>{
    ttsEnabled = !ttsEnabled;
    localStorage.setItem('ttsEnabled', ttsEnabled);
    ttsStatusEl.textContent = ttsEnabled ? 'on' : 'off';
    speak(ttsEnabled ? 'Text to speech enabled' : 'Text to speech disabled');
  });

  /* Notifications: persist UI, avoid re-request when already granted */
  function updateNotifUI(){ enableNotifBtn.textContent = (localStorage.getItem('notifEnabled') === 'true') ? 'Notifications Enabled' : 'Enable Notifications'; }
  updateNotifUI();

  enableNotifBtn.addEventListener('click', async ()=>{
    if(!('Notification' in window)){ alert('Browser does not support notifications'); return; }
    const p = await Notification.requestPermission();
    const granted = (p === 'granted');
    saveJSON('notifEnabled', granted);
    updateNotifUI();
    if(granted) {
      try { new Notification('Sunnah Lifestyle', { body: 'Notifications enabled' }); } catch(e){}
    }
  });

  function showNotification(title, body){
    if(localStorage.getItem('notifEnabled') === 'true'){
      try{ new Notification(title, { body }); }catch(e){ console.warn('notif show err', e); }
    }
  }

  /* =========================
     Prayer times (Aladhan)
     ========================= */
  const prayerOrder = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  let prayerTimings = {}, hijriInfo = null;

  async function fetchPrayerTimes(lat, lon){
    try{
      const ts = Math.floor(Date.now()/1000);
      const url = `https://api.aladhan.com/v1/timings/${ts}?latitude=${lat}&longitude=${lon}&method=2`;
      const res = await fetch(url);
      const data = await res.json();
      if(data && data.data && data.data.timings){
        const raw = data.data.timings;
        const sanitized = {};
        ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'].forEach(k=>{
          if(raw[k]){
            const m = String(raw[k]).match(/(\d{1,2}:\d{2})/);
            sanitized[k] = m ? m[1] : raw[k];
          }
        });
        prayerTimings = sanitized;
        hijriInfo = (data.data.date && data.data.date.hijri) ? data.data.date.hijri : null;
        renderPrayerList();
      } else throw new Error('Invalid API');
    }catch(e){
      console.warn('Prayer API failed', e);
      prayerTimings = { Fajr:'05:00', Dhuhr:'12:00', Asr:'15:00', Maghrib:'18:00', Isha:'19:30' };
      renderPrayerList();
    }
  }

  function renderPrayerList(){
    prayerListEl.innerHTML = '';
    prayerOrder.forEach(p=>{
      const t = prayerTimings[p] || 'â€”';
      const li = document.createElement('li');
      li.innerHTML = `<b>${p}</b>: ${t}`;
      prayerListEl.appendChild(li);
    });
    nextPrayerEl.textContent = computeNextPrayerText();
    renderPrayerChecklist();
  }

  function timeToDateToday(hhmm){
    const [hh,mm] = String(hhmm||'00:00').split(':').map(Number);
    const d = new Date(); d.setHours(hh,mm,0,0); return d;
  }

  function computeNextPrayerText(){
    const now = new Date();
    for(const p of prayerOrder){
      if(prayerTimings[p]){
        const t = timeToDateToday(prayerTimings[p]);
        if(t > now) return `${p} ${prayerTimings[p]}`;
      }
    }
    const t = prayerTimings['Fajr'] || '05:00';
    return `Fajr ${t} (tomorrow)`;
  }

  /* Prayer checklist logic: checkbox only active in its time window */
  function renderPrayerChecklist(){
    // ensure container exists
    let pc = document.getElementById('prayerChecklist');
    if(!pc){
      pc = document.createElement('div');
      pc.id = 'prayerChecklist';
      prayerListEl.parentNode.appendChild(pc);
    }
    pc.innerHTML = '';
    const temp = loadJSON('dailyTemp', {});
    prayerOrder.forEach((p, idx)=>{
      const id = `chk-${p}`;
      const t = prayerTimings[p] || 'â€”';
      const checked = temp[id] ? 'checked' : '';
      const label = document.createElement('label');
      label.className = 'mini flex items-center gap-3';
      label.innerHTML = `<input type="checkbox" id="${id}" data-prayer="${p}" ${checked}/> <div><b>${p}</b><div class="small-muted">${t}</div></div>`;
      pc.appendChild(label);
    });
    updatePrayerChecklistAvailability();
    pc.querySelectorAll('input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', (e)=>{
        const id = cb.id;
        const tmp = loadJSON('dailyTemp', {});
        tmp[id] = cb.checked;
        saveJSON('dailyTemp', tmp);
        if(cb.checked){
          saveActivity('Sholat', cb.dataset.prayer, 0);
          speak(`${cb.dataset.prayer} recorded`, 'en-US');
          showNotification('Prayer recorded', `${cb.dataset.prayer}`);
        }
      });
    });
  }

  function updatePrayerChecklistAvailability(){
    const now = new Date();
    const inputs = document.querySelectorAll('#prayerChecklist input[type=checkbox]');
    inputs.forEach((inp, idx)=>{
      const p = inp.dataset.prayer;
      const t = prayerTimings[p];
      if(!t){ inp.disabled = true; inp.parentElement.classList.add('locked'); return; }
      const start = timeToDateToday(t);
      // find next prayer start
      let nextStart = null;
      for(let j=idx+1;j<prayerOrder.length;j++){
        if(prayerTimings[prayerOrder[j]]){
          nextStart = timeToDateToday(prayerTimings[prayerOrder[j]]);
          break;
        }
      }
      if(!nextStart){
        nextStart = new Date(start); nextStart.setDate(nextStart.getDate()+1);
        const fj = prayerTimings['Fajr'] || '05:00';
        const fjParts = fj.split(':').map(Number);
        nextStart.setHours(fjParts[0], fjParts[1],0,0);
      }
      const allowed = now >= start && now < nextStart;
      inp.disabled = !allowed;
      inp.parentElement.classList.toggle('locked', !allowed);
    });
  }

 /* =========================
   Murajaah loader â€” data from data/quran.json
   ========================= */
function pickMurajaahThreeFromList(list){
  const d = new Date();
  const idx = (d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate()) % list.length;
  const three = [];
  for(let i=0;i<3;i++) three.push(list[(idx + i) % list.length]);
  return three;
}

async function loadQuranJSON(){
  try{
    const r = await fetch('data/quran.json');
    quranData = await r.json();
    renderMurajaah();
  }catch(e){
    console.warn('Failed loading quran.json', e);
    quranData = null;
    murajaahBox.innerHTML = '<div class="small-muted">Quran data not loaded (data/quran.json missing)</div>';
  }
}

function renderMurajaah(){
  const todayISO = (new Date()).toISOString().slice(0,10);
  let mem = loadJSON('murajaahToday', null);
  if(!mem || mem.date !== todayISO){
    const picks = quranData ? pickMurajaahThreeFromList(quranData) : ['Data missing'];
    mem = { date: todayISO, surahs: picks.map(s => s.name || s) };
    saveJSON('murajaahToday', mem);
  }
  murajaahBox.innerHTML = '';

  mem.surahs.forEach(sName => {
    const sObj = quranData ? quranData.find(x => x.name === sName) : null;
    const box = document.createElement('div');
    box.className = 'mini surah-box';

    box.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <b>${sName}</b>
          <div class="small-muted">${sObj ? sObj.translation : ''}</div>
        </div>
        <div>
          <button class="btn btn-emerald read-surah" data-surah="${sName}">Read</button>
        </div>
      </div>
    `;

    murajaahBox.appendChild(box);
  });

  // event listener untuk tombol Read
  document.querySelectorAll('.read-surah').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const sName = ev.currentTarget.dataset.surah;
      const sObj = quranData.find(x => x.name === sName);
      openQuranModal(sObj);
    });
  });
}

/* Modal Qurâ€™an */
function openQuranModal(surah) {
  document.getElementById("quranModalTitle").textContent = surah.name + " (" + surah.translation + ")";
  
  let contentHtml = "";
  surah.verses.forEach((v, i) => {
    contentHtml += `
      <div class="border-b pb-2">
        <p class="text-right text-lg font-arabic">${v.arabic}</p>
        <p class="text-sm text-gray-700">${i+1}. ${v.translation}</p>
      </div>
    `;
  });
  
  document.getElementById("quranModalContent").innerHTML = contentHtml;
  document.getElementById("quranModal").classList.remove("hidden");
}

function closeQuranModal() {
  document.getElementById("quranModal").classList.add("hidden");
}

  /* =========================
     Weekly exercises
     ========================= */
  const weeklyExercises = {
    0: [ {title:'Rest / Light Walk', desc:'20 min walk'}, ],
    1: [ {title:'Push Ups', desc:'3 sets x 15'}, {title:'Plank', desc:'2 x 60s'} ],
    2: [ {title:'Squats', desc:'3 x 20'}, {title:'Jog', desc:'2 km'} ],
    3: [ {title:'Sit Ups', desc:'3 x 20'}, {title:'Stretch', desc:'10 min'} ],
    4: [ {title:'Interval Run', desc:'20 min intervals'}, {title:'Push Ups', desc:'2 x 20'} ],
    5: [ {title:'Cycling', desc:'5 km'}, {title:'Light Core', desc:'10 min'} ],
    6: [ {title:'Yoga / Mobility', desc:'30 min'}, ]
  };

  function renderExerciseSchedule(){
    exerciseScheduleEl.innerHTML = '';
    const today = new Date().getDay();
    for(let d=0; d<7; d++){
      const box = document.createElement('div');
      box.className = 'mini';
      const label = d === today ? '<b>Today</b>' : new Date(1970,0,d).toLocaleDateString(undefined,{weekday:'long'});
      box.innerHTML = `<div class="flex justify-between"><div><b>${label}</b></div><div class="small-muted">${d===today?'Active':''}</div></div>`;
      weeklyExercises[d].forEach((ex,i)=>{
        const chkId = `ex-${d}-${i}`;
        const checked = loadJSON('exerciseDone', {})[chkId] ? 'checked' : '';
        box.innerHTML += `<div class="mt-2"><label class="flex items-center gap-2"><input type="checkbox" data-day="${d}" id="${chkId}" ${checked} /> <div><b>${ex.title}</b><div class="small-muted">${ex.desc}</div></div></label></div>`;
      });
      exerciseScheduleEl.appendChild(box);
    }
    document.querySelectorAll('[id^=ex-]').forEach(cb=>{
      cb.addEventListener('change', (ev)=>{
        const id = ev.target.id;
        const store = loadJSON('exerciseDone', {});
        store[id] = ev.target.checked;
        saveJSON('exerciseDone', store);
        if(ev.target.checked){
          const d = Number(ev.target.dataset.day);
          if(d === new Date().getDay()){
            saveActivity('Exercise', `Done ${id}`, 0);
            speak('Exercise dicatat', 'id-ID');
          } else {
            alert('You can mark only the exercise for its scheduled day.');
            ev.target.checked = false;
            store[id] = false;
            saveJSON('exerciseDone', store);
          }
        }
      });
    });
  }

  /* =========================
     Meals availability windows
     ========================= */
  function isNowBetween(h1,m1,h2,m2){
    const now = new Date();
    const start = new Date(); start.setHours(h1,m1,0,0);
    const end = new Date(); end.setHours(h2,m2,0,0);
    return now >= start && now <= end;
  }
  function updateMealAvailability(){
    document.getElementById('chkBreakfast').disabled = !isNowBetween(7,0,9,0);
    document.getElementById('chkLunch').disabled = !isNowBetween(12,30,14,0);
    document.getElementById('chkDinner').disabled = !isNowBetween(18,30,20,0);
  }
  setInterval(updateMealAvailability, 1000);
  updateMealAvailability();
  document.getElementById('chkBreakfast').addEventListener('change', (e)=>{ if(e.target.checked){ saveActivity('Meal','Breakfast',0); speak('Breakfast dicatat','id-ID'); }});
  document.getElementById('chkLunch').addEventListener('change', (e)=>{ if(e.target.checked){ saveActivity('Meal','Lunch',0); speak('Lunch dicatat','id-ID'); }});
  document.getElementById('chkDinner').addEventListener('change', (e)=>{ if(e.target.checked){ saveActivity('Meal','Dinner',0); speak('Dinner dicatat','id-ID'); }});

  /* =========================
     Map & Tracking (Leaflet)
     ========================= */
  let map=null, polyline=null, watchId=null, tracking=false;
  let trackCoords = [], trackStart=null, trackDist=0, elapsedInterval=null;

  function initMap(){
    try{
      const initial = userCoords ? [userCoords.lat, userCoords.lon] : [0,0];
      map = L.map('map', { zoomControl:true }).setView(initial, userCoords ? 14 : 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
      polyline = L.polyline([], { color: '#06b6d4' }).addTo(map);
    }catch(e){ console.warn('initMap', e); }
  }
  initMap();

  function haversine(a,b){
    const R = 6371e3;
    const Ï†1 = a.lat * Math.PI/180, Ï†2 = b.lat * Math.PI/180;
    const Î”Ï† = (b.lat-a.lat) * Math.PI/180, Î”Î» = (b.lon-a.lon) * Math.PI/180;
    const sinÎ”Ï†2 = Math.sin(Î”Ï†/2), sinÎ”Î»2 = Math.sin(Î”Î»/2);
    const aa = (sinÎ”Ï†2*sinÎ”Ï†2) + Math.cos(Ï†1) * Math.cos(Ï†2) * (sinÎ”Î»2*sinÎ”Î»2);
    const c = 2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
    return R*c;
  }

  function computePace(meters, seconds){
    if(!meters || meters < 5) return 'â€”';
    const km = meters/1000;
    const mins = seconds/60;
    const pace = mins / km;
    const pmin = Math.floor(pace);
    const psec = Math.round((pace - pmin)*60);
    return `${pmin}:${String(psec).padStart(2,'0')} min/km`;
  }

  function startTrack(){
    if(!navigator.geolocation) return alert('Geolocation not supported');
    if(tracking) return;
    trackCoords = []; trackDist = 0; trackStart = new Date();
    document.getElementById('trackStatus').textContent = 'Tracking...'; tracking = true;
    if(polyline) polyline.setLatLngs([]);
    watchId = navigator.geolocation.watchPosition(p=>{
      const lat = p.coords.latitude, lon = p.coords.longitude;
      const pt = { lat, lon, ts: Date.now() };
      if(trackCoords.length > 0){
        const last = trackCoords[trackCoords.length-1];
        const d = haversine({lat:last.lat, lon:last.lon},{lat,lon});
        if(!isNaN(d) && d>0) trackDist += d;
      }
      trackCoords.push(pt);
      if(polyline) polyline.addLatLng([lat,lon]);
      if(map) map.setView([lat,lon], 15);
      document.getElementById('trackDistance').textContent = `${(trackDist/1000).toFixed(2)} km`;
    }, err=>{ console.warn('track err', err); }, { enableHighAccuracy:true, maximumAge:1000 });

    elapsedInterval = setInterval(()=>{
      const s = Math.floor((Date.now() - trackStart.getTime())/1000);
      const hh = pad(Math.floor(s/3600)), mm = pad(Math.floor((s%3600)/60)), ss = pad(s%60);
      document.getElementById('trackElapsed').textContent = `${hh}:${mm}:${ss}`;
      document.getElementById('trackDistance').textContent = `${(trackDist/1000).toFixed(2)} km`;
      document.getElementById('trackPace').textContent = computePace(trackDist, s);
    }, 1000);
  }

  function pauseTrack(){
    if(!tracking) return;
    if(watchId) navigator.geolocation.clearWatch(watchId);
    if(elapsedInterval) clearInterval(elapsedInterval);
    watchId = null; elapsedInterval = null;
    document.getElementById('trackStatus').textContent = 'Paused'; tracking = false;
  }

  function stopAndSaveTrack(){
    if(watchId) navigator.geolocation.clearWatch(watchId);
    if(elapsedInterval) clearInterval(elapsedInterval);
    document.getElementById('trackStatus').textContent = 'Stopped';
    if(trackCoords.length > 0){
      const duration_s = Math.floor((Date.now() - trackStart.getTime())/1000);
      const runs = loadJSON('runs', []);
      const runObj = { id: Date.now(), coords: trackCoords, dist_m: Math.round(trackDist), start_ts: trackStart.getTime(), duration_s: duration_s };
      runs.push(runObj);
      saveJSON('runs', runs);
      saveActivity('Run', `Distance ${(trackDist/1000).toFixed(2)} km`, 0);
      speak('Run saved', 'id-ID');
      renderRunsList();
    } else {
      alert('No activity recorded');
    }
    trackCoords = []; trackDist = 0; document.getElementById('trackDistance').textContent = '0.00 km';
    document.getElementById('trackElapsed').textContent = '00:00:00'; document.getElementById('trackPace').textContent = 'â€”';
    tracking = false; watchId = null;
  }

  document.getElementById('startTrack').addEventListener('click', ()=>{ startTrack(); speak('Tracking started'); });
  document.getElementById('pauseTrack').addEventListener('click', ()=>{ pauseTrack(); speak('Tracking paused'); });
  document.getElementById('stopTrack').addEventListener('click', ()=>{ stopAndSaveTrack(); });

  function renderRunsList(){
    const wrap = document.getElementById('runsListWrap');
    const runs = loadJSON('runs', []);
    if(!wrap) return;
    if(runs.length === 0){ wrap.innerHTML = `<div class="small-muted">No saved runs</div>`; document.getElementById('runDetail').textContent = 'No run selected'; return; }
    wrap.innerHTML = runs.slice().reverse().map(r=>{
      const d = new Date(r.start_ts);
      const label = `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
      const km = (r.dist_m/1000).toFixed(2);
      const dur = (function(s){ const hh = Math.floor(s/3600), mm = Math.floor((s%3600)/60), ss = s%60; return `${pad(hh)}:${pad(mm)}:${pad(ss)}`; })(r.duration_s||0);
      return `<div class="flex items-center justify-between gap-2 mb-2 border-b border-white/6 pb-2">
        <div><div class="font-semibold">${label}</div><div class="small-muted text-sm">${km} km â€¢ ${dur}</div></div>
        <div class="flex flex-col gap-2"><button class="btn btn-emerald view-run" data-id="${r.id}">View</button><button class="btn btn-soft select-run" data-id="${r.id}">Select</button></div>
      </div>`;
    }).join('');
    wrap.querySelectorAll('.view-run').forEach(b=>b.addEventListener('click', (e)=>{ viewRunOnMap(Number(e.currentTarget.dataset.id)); }));
    wrap.querySelectorAll('.select-run').forEach(b=>b.addEventListener('click', (e)=>{ selectRun(Number(e.currentTarget.dataset.id)); }));
  }

  function selectRun(id){
    const runs = loadJSON('runs', []);
    const r = runs.find(x=>x.id===id);
    if(!r){ alert('Run not found'); return; }
    document.getElementById('runDetail').innerHTML = `<div><b>${new Date(r.start_ts).toLocaleString()}</b></div><div class="small-muted mt-1">${(r.dist_m/1000).toFixed(2)} km â€¢ ${Math.floor(r.duration_s/60)}m</div>`;
    if(!map) initMap();
    if(polyline) polyline.setLatLngs([]);
    const latlngs = r.coords.map(p=>[p.lat,p.lon]);
    if(polyline) polyline.setLatLngs(latlngs);
    if(latlngs.length) map.fitBounds(latlngs, { maxZoom:16 });
  }

  document.getElementById('viewRunOnMapBtn').addEventListener('click', ()=>{ alert('Select a run first'); });
  document.getElementById('deleteRunBtn').addEventListener('click', ()=>{
    const detail = document.getElementById('runDetail').innerText;
    if(detail.includes('No run selected')) return alert('Select a run first');
    if(!confirm('Delete selected run?')) return;
    let runs = loadJSON('runs', []);
    runs = runs.slice(0, -1); // naive deletion for demo (improve by tracking selected id)
    saveJSON('runs', runs);
    renderRunsList();
    document.getElementById('runDetail').textContent = 'No run selected';
  });

  document.getElementById('clearRunsBtn').addEventListener('click', ()=>{ if(!confirm('Clear all runs?')) return; saveJSON('runs', []); renderRunsList(); });
  document.getElementById('exportAllRunsBtn').addEventListener('click', ()=>{
    const runs = loadJSON('runs', []);
    const blob = new Blob([JSON.stringify(runs,null,2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `runs-${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  /* =========================
     Trash & Eco
     ========================= */
  let trashLog = loadJSON('trashLog', []);
  function renderTrash(){
    const ul = document.getElementById('trashList');
    const today = new Date().toLocaleDateString();
    const tlog = trashLog.filter(t => t.date === today);
    ul.innerHTML = tlog.map(t=>`<li>${t.time} â€” ${t.type}: ${t.weight} g</li>`).join('') || '<li class="small-muted">No entries today</li>';
    const total = tlog.reduce((s,t)=>s + Number(t.weight), 0);
    document.getElementById('trashTotal').textContent = `Total: ${total} g`;
  }
  renderTrash();

  document.getElementById('addTrashBtn').addEventListener('click', ()=>{
    const type = (document.getElementById('trashType').value || '').trim() || 'Other';
    const weight = parseInt(document.getElementById('trashWeight').value) || 0;
    if(!weight) return alert('Enter weight in grams');
    const now = new Date();
    const item = { date: now.toLocaleDateString(), time: now.toLocaleTimeString(), type, weight };
    trashLog.push(item);
    saveJSON('trashLog', trashLog);
    document.getElementById('trashType').value=''; document.getElementById('trashWeight').value='';
    renderTrash();
    saveActivity('Trash', `${weight} g (${type})`, 0);
    speak(`Trash logged ${weight} grams ${type}`, 'id-ID');
  });
  document.getElementById('clearTrashBtn').addEventListener('click', ()=>{
    if(!confirm('Clear today trash?')) return;
    const today = new Date().toLocaleDateString();
    trashLog = trashLog.filter(t=>t.date !== today);
    saveJSON('trashLog', trashLog);
    renderTrash();
  });

  const challengesTemplate = [
    {id:'c1', text:'Bring your own water bottle', pts:5},
    {id:'c2', text:'Use a reusable bag', pts:4},
    {id:'c3', text:'Cycle instead of driving for 2 km', pts:8},
    {id:'c4', text:'Pick up 3 pieces of trash', pts:6},
  ];
  let ecoPoints = Number(localStorage.getItem('ecoPoints') || 0);
  function renderChallenges(){
    const wrap = document.getElementById('challengeList');
    const done = loadJSON('chDone', {});
    wrap.innerHTML = challengesTemplate.map(c=>{
      const checked = done[c.id] ? 'checked' : '';
      return `<li class="mini flex justify-between items-center"><div><input type="checkbox" data-id="${c.id}" ${checked}/> <span class="small-muted ml-2">${c.text}</span></div><div class="small-muted">${c.pts} pts</div></li>`;
    }).join('');
    document.getElementById('ecoPoints').textContent = ecoPoints;
    document.querySelectorAll('#challengeList input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', (e)=>{
        const id = e.target.dataset.id;
        const conf = challengesTemplate.find(x=>x.id===id);
        const done = loadJSON('chDone', {});
        if(e.target.checked){
          done[id] = true; ecoPoints += conf.pts; saveActivity('Eco Challenge', conf.text, conf.pts); speak(`${conf.text} completed. +${conf.pts} pts`);
        } else {
          delete done[id]; ecoPoints -= conf.pts; speak(`${conf.text} unchecked.`);
        }
        saveJSON('chDone', done); localStorage.setItem('ecoPoints', ecoPoints);
        document.getElementById('ecoPoints').textContent = ecoPoints;
      });
    });
  }
  renderChallenges();

  /* =========================
     History & daily summary & streaks
     ========================= */
  function iso(d=new Date()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function labelFromDate(d=new Date()){ return d.toLocaleDateString(undefined,{ day:'2-digit', month:'short', year:'numeric' }); }

  function loadActivityHistory(){ return loadJSON('activityHistory', []); }
  function saveActivityHistory(arr){ saveJSON('activityHistory', arr); }

  function saveActivity(type, detail, points=0){
    const now = new Date();
    const arr = loadActivityHistory();
    arr.push({ dateISO: iso(now), label: labelFromDate(now), type, detail, points, ts:Date.now() });
    saveActivityHistory(arr);
    addToDailySummary(type, detail, points);
    const hs = document.getElementById('historySection');
    if(hs && hs.style.display==='block') renderHistoryList();
  }

  function addToDailySummary(type, detail, points){
    const key = iso();
    const store = loadJSON('dailySummary', {});
    if(!store[key]) store[key] = { dateLabel: labelFromDate(new Date()), trash:{ total:0, breakdown:{} }, ecoPoints:0, activities:[] };
    const day = store[key];
    if(type === 'Trash'){
      const m = String(detail).match(/(\d+)/);
      const w = m ? Number(m[1]) : 0;
      day.trash.total = (day.trash.total || 0) + w;
      const kindM = String(detail).match(/\(([^)]+)\)/);
      const kind = kindM ? kindM[1] : 'Other';
      day.trash.breakdown[kind] = (day.trash.breakdown[kind] || 0) + w;
    } else if(type === 'Eco Challenge'){
      day.ecoPoints = (day.ecoPoints || 0) + (points || 0);
      day.activities.push(`${type}: ${detail} (+${points} pts)`);
    } else {
      day.activities.push(`${type}: ${detail}${points ? ' (+'+points+' pts)' : ''}`);
      if(points) day.ecoPoints = (day.ecoPoints || 0) + points;
    }
    saveJSON('dailySummary', store);
  }

  function renderHistoryList(){
    const wrap = document.getElementById('historyList');
    const daily = loadJSON('dailySummary', {});
    const keys = Object.keys(daily).sort((a,b)=> b.localeCompare(a));
    if(keys.length===0){ wrap.innerHTML = `<div class="small-muted">Belum ada riwayat aktivitas</div>`; speak('No activity history yet'); return; }
    wrap.innerHTML = keys.map(k=>{
      const day = daily[k];
      const trashTotal = (day.trash && day.trash.total) ? day.trash.total : 0;
      const eco = day.ecoPoints || 0;
      const acts = day.activities || [];
      return `<div class="border-b border-white/6 pb-2">
        <button class="history-day w-full text-left py-2" data-key="${k}">
          <div class="font-semibold">${day.dateLabel || k}</div>
          <div class="small-muted">${trashTotal} g trash â€¢ ${eco} pts â€¢ ${acts.length} activities</div>
        </button>
        <div class="history-detail hidden mt-2 small-muted" id="detail-${k.replace(/:/g,'-')}"></div>
      </div>`;
    }).join('');
    wrap.querySelectorAll('.history-day').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.key;
        const detailEl = document.getElementById(`detail-${key.replace(/:/g,'-')}`);
        if(!detailEl) return;
        if(!detailEl.innerHTML){
          const day = loadJSON('dailySummary', {})[key];
          const trash = day.trash || { total:0, breakdown:{} };
          const breakdown = Object.keys(trash.breakdown||{}).map(k=>`${k} ${trash.breakdown[k]} g`).join(', ');
          const activities = (day.activities || []).map(a=>`<li>${a}</li>`).join('') || '<li>No activities</li>';
          detailEl.innerHTML = `<ul class="list-disc ml-6">
            <li>Trash: ${trash.total} g ${breakdown ? `(${breakdown})` : ''}</li>
            <li>Eco Points: ${day.ecoPoints || 0} pts</li>
            <li>Activities:</li>
            <ul class="ml-6">${activities}</ul>
          </ul>`;
        }
        detailEl.classList.toggle('hidden');
        const day = loadJSON('dailySummary', {})[key];
        const summaryText = `${day.dateLabel}. Trash ${day.trash.total} grams. Eco points ${day.ecoPoints || 0}. ${(day.activities||[]).length} activities.`;
        speak(summaryText,'id-ID');
      });
    });
  }

  document.getElementById('toggleHistoryBtn').addEventListener('click', ()=>{
    const sec = document.getElementById('historySection');
    if(sec.style.display === 'block'){ sec.style.display = 'none'; speak('History closed','id-ID'); }
    else { sec.style.display = 'block'; renderHistoryList(); sec.scrollIntoView({behavior:'smooth'}); speak('Displaying activity history','id-ID'); }
  });

  /* =========================
     Streak logic
     ========================= */
  function loadStreak(){ return loadJSON('streakInfo', { streak:0, lastDateISO:null, restoresThisMonth:0, monthKey: null }); }
  function saveStreak(s){ saveJSON('streakInfo', s); }
  function monthKey(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; }
  function todayISO(){ return iso(new Date()); }

  function updateStreakUI(){
    const s = loadStreak();
    document.getElementById('streakBadge').textContent = s.streak || 0;
    if(s.monthKey !== monthKey()){ s.monthKey = monthKey(); s.restoresThisMonth = 0; saveStreak(s); }
    document.getElementById('restoresLeft').textContent = Math.max(0, 3 - (s.restoresThisMonth||0));
  }
  updateStreakUI();

  document.getElementById('saveChecklistBtn').addEventListener('click', ()=>{
    const prayerInputs = document.querySelectorAll('#prayerChecklist input[type=checkbox]');
    const prayersAll = Array.from(prayerInputs).every(cb => cb.checked);
    const eco = document.getElementById('chkAllEco').checked;
    const exercise = document.getElementById('chkAllExercise').checked;
    const meals = document.getElementById('chkBreakfast').checked && document.getElementById('chkLunch').checked && document.getElementById('chkDinner').checked;
    const items = [];
    prayerInputs.forEach(cb => items.push(`${cb.dataset.prayer}:${cb.checked?'done':'no'}`));
    items.push(`Eco:${eco}`); items.push(`Exercise:${exercise}`); items.push(`Meals:${meals}`);
    saveActivity('Checklist', items.join('; '), 0);
    document.getElementById('lastChecklist').textContent = new Date().toLocaleString();
    const s = loadStreak();
    const today = todayISO();
    if(prayersAll && eco && exercise && meals){
      if(s.lastDateISO === today) { alert('Already submitted today'); speak('Already submitted today','id-ID'); }
      else {
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
        const yiso = iso(yesterday);
        if(s.lastDateISO === yiso) s.streak = (s.streak||0) + 1;
        else s.streak = 1;
        s.lastDateISO = today;
        saveStreak(s); updateStreakUI();
        speak(`Selamat, streakmu sekarang ${s.streak} hari`, 'id-ID');
      }
    } else {
      speak('Checklist saved, streak tidak bertambah', 'id-ID');
      alert('Checklist saved. Streak tidak bertambah kecuali semua item terpenuhi.');
    }
  });

  document.getElementById('clearChecklistBtn').addEventListener('click', ()=>{
    document.querySelectorAll('#prayerChecklist input[type=checkbox]').forEach(cb=>cb.checked=false);
    document.getElementById('chkAllEco').checked=false; document.getElementById('chkAllExercise').checked=false;
  });

  document.getElementById('streakBadge').addEventListener('click', ()=>{
    const s = loadStreak();
    if(s.monthKey !== monthKey()) { s.monthKey = monthKey(); s.restoresThisMonth = 0; }
    if((s.restoresThisMonth||0) >= 3){ alert('No restore left this month'); speak('No restore left this month','id-ID'); return; }
    s.streak = (s.streak || 0) + 1;
    s.restoresThisMonth = (s.restoresThisMonth||0) + 1;
    s.lastDateISO = todayISO();
    saveStreak(s); updateStreakUI();
    speak('Streak restored by one day', 'id-ID');
  });

  /* =========================
     Initialization
     ========================= */
  function initAll(){
    renderExerciseSchedule();
    renderChallenges();
    renderRunsList();
    renderTrash();
    updateStreakUI();

    // load quran data (external JSON)
    loadQuranJSON();

    // geolocation & prayer init
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        locationDisplay.textContent = `Location: ${userCoords.lat.toFixed(4)}, ${userCoords.lon.toFixed(4)}`;
        locationDisplayAlt.textContent = `Location: ${userCoords.lat.toFixed(4)}, ${userCoords.lon.toFixed(4)}`;
        if(map) map.setView([userCoords.lat, userCoords.lon], 13);
        fetchPrayerTimes(userCoords.lat, userCoords.lon);
      }, err=>{
        console.warn('loc error', err);
        userCoords = { lat:-6.2088, lon:106.8456 };
        locationDisplay.textContent = 'Location denied â€” Jakarta fallback';
        locationDisplayAlt.textContent = 'Jakarta fallback';
        fetchPrayerTimes(userCoords.lat, userCoords.lon);
      }, { enableHighAccuracy:true, timeout:8000 });
    } else {
      userCoords = { lat:-6.2088, lon:106.8456 };
      locationDisplay.textContent = 'Geolocation not supported â€” Jakarta fallback';
      locationDisplayAlt.textContent = 'Jakarta fallback';
      fetchPrayerTimes(userCoords.lat, userCoords.lon);
    }

    // periodic updates
    setInterval(()=>{ updatePrayerChecklistAvailability(); }, 2000);
    // refresh prayer times every 30 minutes
    setInterval(()=>{ if(userCoords) fetchPrayerTimes(userCoords.lat, userCoords.lon); }, 30*60*1000);
  }

  initAll();

  /* =========================
     saveActivity wrapper (single definition)
     ========================= */
  function saveActivity(type, detail, points=0){
    const now = new Date();
    const arr = loadActivityHistory();
    arr.push({ dateISO: iso(now), label: labelFromDate(now), type, detail, points, ts: Date.now() });
    saveActivityHistory(arr);
    addToDailySummary(type, detail, points);
  }

  /* =========================
     Menus/day rotation & midnight handler
     ========================= */
  (function loadMenus(){
    const todayKey = `menus-${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`;
    let menus = loadJSON(todayKey, null);
    if(!menus){
      const breakfastOpts = ["Dates & milk â€” Prophetâ€™s breakfast","Honey & banana â€” energy","Barley bread & yogurt"];
      const lunchOpts = ["Brown rice & grilled chicken","Quinoa & tuna salad","Whole grain bread & hummus"];
      const dinnerOpts = ["Light veggie soup & yogurt","Goat milk & dates","Fresh fruits & tea"];
      menus = {
        breakfast: breakfastOpts[Math.floor(Math.random()*breakfastOpts.length)],
        lunch: lunchOpts[Math.floor(Math.random()*lunchOpts.length)],
        dinner: dinnerOpts[Math.floor(Math.random()*dinnerOpts.length)]
      };
      saveJSON(todayKey, menus);
    }
    document.getElementById('breakfastMenu').textContent = menus.breakfast;
    document.getElementById('lunchMenu').textContent = menus.lunch;
    document.getElementById('dinnerMenu').textContent = menus.dinner;
  })();

  function midnightWatcher(){
    const now = new Date();
    const next = new Date(now); next.setHours(24,0,0,0);
    const ms = next - now + 1000;
    setTimeout(()=>{
      // new day tasks
      // clear daily temp for checklists and murajaah will auto-generate next day
      saveJSON('dailyTemp', {});
      // generate new menus
      const d = new Date();
      const key = `menus-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
      // regenerate menus
      const breakfastOpts = ["Dates & milk â€” Prophetâ€™s breakfast","Honey & banana â€” energy","Barley bread & yogurt"];
      const lunchOpts = ["Brown rice & grilled chicken","Quinoa & tuna salad","Whole grain bread & hummus"];
      const dinnerOpts = ["Light veggie soup & yogurt","Goat milk & dates","Fresh fruits & tea"];
      const menus = {
        breakfast: breakfastOpts[Math.floor(Math.random()*breakfastOpts.length)],
        lunch: lunchOpts[Math.floor(Math.random()*lunchOpts.length)],
        dinner: dinnerOpts[Math.floor(Math.random()*dinnerOpts.length)]
      };
      saveJSON(key, menus);
      // reload UI
      document.getElementById('breakfastMenu').textContent = menus.breakfast;
      document.getElementById('lunchMenu').textContent = menus.lunch;
      document.getElementById('dinnerMenu').textContent = menus.dinner;
      // rerun schedule build if needed
      midnightWatcher();
    }, ms);
  }
  midnightWatcher();

  /* =========================
     Service Worker registration (minimal)
     ========================= */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.warn('SW reg failed', err));
  }

  /* cancel TTS on unload */
  window.addEventListener('beforeunload', ()=>{ try{ speechSynthesis.cancel(); }catch(e){} });

  </script>
</body>
</html>

